#include <stdio.h>
#include <stdlib.h>
#include <string.h>



// EXP file size in the directory.  ISO image retains Little Endian and then Big Endian integers.
// ENDING.EXP
unsigned char fileSize1_from[]=
{
	0x9B,0x1B,0x01,0x00,0x00,0x01,0x1B,0x9B
};
unsigned char fileSize1_to[]=
{
0x00,0x20,0x01,0x00,0x00,0x01,0x20,0x00
};
// LASINT.EXP
unsigned char fileSize2_from[]=
{
0x03,0x98,0x06,0x00,0x00,0x06,0x98,0x03
};
unsigned char fileSize2_to[]=
{
0x00,0xA0,0x06,0x00,0x00,0x06,0xA0,0x00
};
// LASINT2.EXP
unsigned char fileSize3_from[]=
{
0xE4,0x9E,0x06,0x00,0x00,0x06,0x9E,0xE4
};
unsigned char fileSize3_to[]=
{
0x00,0xA0,0x06,0x00,0x00,0x06,0xA0,0x00
};


// EXP size.
unsigned char EXPHeader1_from[]=
{
	0x4D,0x50,0x03,0x00,0x4D,0x03,0x00,0x00,0x20,0x00,0x41,0x01,0xFF,0xFF
};
unsigned char EXPHeader1_to[]=
{
	0x4D,0x50,0x00,0x00,0x50,0x03,0x00,0x00,0x20,0x00,0x42,0x01,0xFF,0xFF
};
unsigned char EXPHeader2_from[]=
{
	0x4D,0x50,0xE4,0x00,0x50,0x03,0x00,0x00,0x20,0x00,0x43,0x01,0xFF,0xFF
};
unsigned char EXPHeader2_to[]=
{
	0x4D,0x50,0x00,0x00,0x50,0x03,0x00,0x00,0x20,0x00,0x44,0x01,0xFF,0xFF
};
unsigned char EXPHeader3_from[]=
{
	0x50,0x33,0x01,0x00,0x80,0x01,0x9B,0x1B,0x01,0x00,0xBA,0xD0,0x80,0x01
};
unsigned char EXPHeader3_to[]=
{
	0x50,0x33,0x01,0x00,0x80,0x01,0x00,0x20,0x01,0x00,0xBA,0xD0,0x80,0x01
};
unsigned char EXPHeader4_from[]=
{
	0x2F,0x67,0x04,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00
};
unsigned char EXPHeader4_to[]=
{
	0x2F,0x77,0x04,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00
};


// Uncompressor transfer size
unsigned char tfr1_from[]=
{
	0xBE,0x02,0x96,0x06,0x00,                // MOV     ESI,00069602H
	0xB9,0x10,0x01,0x00,0x00                 // MOV     ECX,00000110H
};
unsigned char tfr1_to[]=
{
	0xBE,0x02,0x97,0x06,0x00,                // MOV     ESI,00069702H
	0xB9,0x10,0x02,0x00,0x00                 // MOV     ECX,00000210H
};
unsigned char tfr2_from[]=
{
	0xBE,0xE3,0x9C,0x06,0x00,                // MOV     ESI,00069CE3H
	0xB9,0x10,0x01,0x00,0x00                 // MOV     ECX,00000110H
};
unsigned char tfr2_to[]=
{
	0xBE,0xE3,0x9D,0x06,0x00,                // MOV     ESI,00069DE3H
	0xB9,0x10,0x02,0x00,0x00                 // MOV     ECX,00000210H
};
unsigned char tfr3_from[]=
{
	0xBE,0x9A,0x19,0x01,0x00,                // MOV     ESI,0001199AH
	0xB9,0xA4,0x01,0x00,0x00                 // MOV     ECX,000001A4H
};
unsigned char tfr3_to[]=
{
	0xBE,0x9A,0x1A,0x01,0x00,                // MOV     ESI,00011A9AH
	0xB9,0xA4,0x02,0x00,0x00                 // MOV     ECX,000002A4H
};



// Patch for LASINT.EXP
unsigned char patch_pattern_lasint[]=
{
	0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x12,0x01,0x01,	// Sector Header
	0x1A,0x00,0xC3																		// Last 3 bytes of PUSH DWORD PTR 001A3810H \\ RET
};

const unsigned char lasint_cdda_code[237]=
{
	0xe8,0x00,0x00,0x00,0x00,0x5e,0x83,0xc6,
	0x11,0xbf,0xfd,0x7f,0x1a,0x00,0xb9,0xd7,
	0x00,0x00,0x00,0xf3,0xa4,0xc3,0x29,0x80,
	0x1a,0x00,0x5d,0x80,0x1a,0x00,0x5d,0x80,
	0x1a,0x00,0x29,0x80,0x1a,0x00,0x29,0x80,
	0x1a,0x00,0x25,0x80,0x1a,0x00,0x2d,0x80,
	0x1a,0x00,0x35,0x80,0x1a,0x00,0x36,0x80,
	0x1a,0x00,0x3a,0x80,0x1a,0x00,0xb4,0x55,
	0xeb,0x06,0xb4,0x52,0xeb,0x02,0xb4,0x56,
	0xb0,0xc0,0x31,0xc9,0xcd,0x93,0xc3,0xb4,
	0x01,0xeb,0x02,0xb4,0x02,0x3a,0x05,0x9a,
	0x97,0x10,0x00,0x74,0xf1,0xa2,0x9a,0x97,
	0x10,0x00,0x50,0xe8,0x13,0x00,0x00,0x00,
	0x20,0xe4,0x58,0x75,0x02,0x31,0xc0,0x66,
	0xa3,0x9b,0x97,0x10,0x00,0xc3,0xa2,0x9a,
	0x97,0x10,0x00,0x83,0xec,0x14,0x0f,0xb6,
	0xc8,0x8d,0x04,0x49,0x8d,0xb4,0x00,0xe0,
	0x96,0x10,0x00,0x66,0xbb,0x01,0x00,0x66,
	0xb8,0xc0,0x25,0xcd,0x21,0x72,0x52,0x66,
	0xc7,0x04,0x24,0x93,0x00,0x66,0x89,0x44,
	0x24,0x02,0x66,0xc7,0x44,0x24,0x0a,0xc0,
	0x50,0xb1,0x60,0x8e,0xc1,0x0f,0xb7,0xf8,
	0xc1,0xe7,0x04,0xc1,0xe9,0x04,0xac,0x88,
	0xc3,0xc0,0xe8,0x04,0xb4,0x0a,0xf6,0xe4,
	0x80,0xe3,0x0f,0x00,0xd8,0xaa,0xe2,0xee,
	0x66,0xb8,0xc0,0x52,0xcd,0x93,0x31,0xff,
	0x89,0xe2,0x66,0xb9,0x01,0x00,0x66,0xb8,
	0x11,0x25,0xcd,0x21,0x66,0x8b,0x4c,0x24,
	0x02,0x50,0x66,0xb8,0xc1,0x25,0xcd,0x21,
	0x58,0x83,0xc4,0x14,0xc3
};

// LASINT2.EXP patch
unsigned char patch_pattern_lasint2[]=
{
	0x68,0x80,0x65,0x1A,0x00,              //  PUSH    DWORD PTR 001A6580H
	0xC3                                   //  RET
};

const unsigned char lasint2_cdda_code[237]=
{
	0xe8,0x00,0x00,0x00,0x00,0x5e,0x83,0xc6,
	0x11,0xbf,0xad,0xad,0x1a,0x00,0xb9,0xd7,
	0x00,0x00,0x00,0xf3,0xa4,0xc3,0xd9,0xad,
	0x1a,0x00,0x0d,0xae,0x1a,0x00,0x0d,0xae,
	0x1a,0x00,0xd9,0xad,0x1a,0x00,0xd9,0xad,
	0x1a,0x00,0xd5,0xad,0x1a,0x00,0xdd,0xad,
	0x1a,0x00,0xe5,0xad,0x1a,0x00,0xe6,0xad,
	0x1a,0x00,0xea,0xad,0x1a,0x00,0xb4,0x55,
	0xeb,0x06,0xb4,0x52,0xeb,0x02,0xb4,0x56,
	0xb0,0xc0,0x31,0xc9,0xcd,0x93,0xc3,0xb4,
	0x01,0xeb,0x02,0xb4,0x02,0x3a,0x05,0x9a,
	0xb2,0x10,0x00,0x74,0xf1,0xa2,0x9a,0xb2,
	0x10,0x00,0x50,0xe8,0x13,0x00,0x00,0x00,
	0x20,0xe4,0x58,0x75,0x02,0x31,0xc0,0x66,
	0xa3,0x9b,0xb2,0x10,0x00,0xc3,0xa2,0x9a,
	0xb2,0x10,0x00,0x83,0xec,0x14,0x0f,0xb6,
	0xc8,0x8d,0x04,0x49,0x8d,0xb4,0x00,0xe0,
	0xb1,0x10,0x00,0x66,0xbb,0x01,0x00,0x66,
	0xb8,0xc0,0x25,0xcd,0x21,0x72,0x52,0x66,
	0xc7,0x04,0x24,0x93,0x00,0x66,0x89,0x44,
	0x24,0x02,0x66,0xc7,0x44,0x24,0x0a,0xc0,
	0x50,0xb1,0x60,0x8e,0xc1,0x0f,0xb7,0xf8,
	0xc1,0xe7,0x04,0xc1,0xe9,0x04,0xac,0x88,
	0xc3,0xc0,0xe8,0x04,0xb4,0x0a,0xf6,0xe4,
	0x80,0xe3,0x0f,0x00,0xd8,0xaa,0xe2,0xee,
	0x66,0xb8,0xc0,0x52,0xcd,0x93,0x31,0xff,
	0x89,0xe2,0x66,0xb9,0x01,0x00,0x66,0xb8,
	0x11,0x25,0xcd,0x21,0x66,0x8b,0x4c,0x24,
	0x02,0x50,0x66,0xb8,0xc1,0x25,0xcd,0x21,
	0x58,0x83,0xc4,0x14,0xc3
};

// ENDING patch
unsigned char patch_pattern_ending[]=
{
	0x68,0x60,0x5F,0x05,0x00,              //  PUSH    DWORD PTR 00055F60H
	0xC3                                   //  RET
};

const unsigned char ending_cdda_code[237]=
{
	0xe8,0x00,0x00,0x00,0x00,0x5e,0x83,0xc6,
	0x11,0xbf,0xbd,0x78,0x05,0x00,0xb9,0xd7,
	0x00,0x00,0x00,0xf3,0xa4,0xc3,0xe9,0x78,
	0x05,0x00,0x1d,0x79,0x05,0x00,0x1d,0x79,
	0x05,0x00,0xe9,0x78,0x05,0x00,0xe9,0x78,
	0x05,0x00,0xe5,0x78,0x05,0x00,0xed,0x78,
	0x05,0x00,0xf5,0x78,0x05,0x00,0xf6,0x78,
	0x05,0x00,0xfa,0x78,0x05,0x00,0xb4,0x55,
	0xeb,0x06,0xb4,0x52,0xeb,0x02,0xb4,0x56,
	0xb0,0xc0,0x31,0xc9,0xcd,0x93,0xc3,0xb4,
	0x01,0xeb,0x02,0xb4,0x02,0x3a,0x05,0x3a,
	0x5f,0x02,0x00,0x74,0xf1,0xa2,0x3a,0x5f,
	0x02,0x00,0x50,0xe8,0x13,0x00,0x00,0x00,
	0x20,0xe4,0x58,0x75,0x02,0x31,0xc0,0x66,
	0xa3,0x3b,0x5f,0x02,0x00,0xc3,0xa2,0x3a,
	0x5f,0x02,0x00,0x83,0xec,0x14,0x0f,0xb6,
	0xc8,0x8d,0x04,0x49,0x8d,0xb4,0x00,0x80,
	0x5e,0x02,0x00,0x66,0xbb,0x01,0x00,0x66,
	0xb8,0xc0,0x25,0xcd,0x21,0x72,0x52,0x66,
	0xc7,0x04,0x24,0x93,0x00,0x66,0x89,0x44,
	0x24,0x02,0x66,0xc7,0x44,0x24,0x0a,0xc0,
	0x50,0xb1,0x60,0x8e,0xc1,0x0f,0xb7,0xf8,
	0xc1,0xe7,0x04,0xc1,0xe9,0x04,0xac,0x88,
	0xc3,0xc0,0xe8,0x04,0xb4,0x0a,0xf6,0xe4,
	0x80,0xe3,0x0f,0x00,0xd8,0xaa,0xe2,0xee,
	0x66,0xb8,0xc0,0x52,0xcd,0x93,0x31,0xff,
	0x89,0xe2,0x66,0xb9,0x01,0x00,0x66,0xb8,
	0x11,0x25,0xcd,0x21,0x66,0x8b,0x4c,0x24,
	0x02,0x50,0x66,0xb8,0xc1,0x25,0xcd,0x21,
	0x58,0x83,0xc4,0x14,0xc3
};


int ApplyPatch(
    int nByte,unsigned char byteData[],
    int nPatchFrom,const unsigned char patchFrom[],
    int nPatchTo,const unsigned char patchTo[])
{
	int nOccurrence=0;
	for(int i=0; i+nPatchFrom<=nByte; ++i)
	{
		int found=1;
		for(int j=0; j<nPatchFrom && i+j<nByte; ++j)
		{
			if(byteData[i+j]!=patchFrom[j])
			{
				found=0;
				break;
			}
		}
		if(0!=found)
		{
			printf("Apply Patch at %08x\n",i);
			for(int j=0; j<nPatchTo; ++j)
			{
				byteData[i+j]=patchTo[j];
			}
			++nOccurrence;
		}
	}
	return nOccurrence;
}

int ApplyPatchExternal(
    size_t nByte,unsigned char byteData[],
    size_t nPatchSig,const unsigned char patchSig[],
    size_t offset_from_signature,
    size_t patchSize,const unsigned char patchData[])
{
	size_t foundOffset=~0;
	for(size_t i=0; i+nPatchSig<nByte; ++i)
	{
		if(0==memcmp(byteData+i,patchSig,nPatchSig))
		{
			foundOffset=i;
			break;
		}
	}

	if(~0==foundOffset)
	{
		return 0;
	}

	unsigned char *loadPoint=byteData+foundOffset+offset_from_signature;

	if(nByte<foundOffset+offset_from_signature+patchSize)
	{
		fprintf(stderr,"Patch does not fit.\n");
		return 0;
	}

	memcpy(loadPoint,patchData,patchSize);

	printf("Applied to offset %llu\n",foundOffset+offset_from_signature);

	return 1;
}

int main(int ac,char *av[])
{
	if(2!=ac)
	{
		fprintf(stderr,"Usage: Patch source-file.bin/mdf/iso\n");
		fprintf(stderr,"  This program applies patches to ChaseHQ for FM TOWNS BIN/MDF image\n");
		fprintf(stderr,"  and makes it runnable from external CD drive + YSSCSICD or RescueIPL.\n");
		return 1;
	}

	int nByte=0,nByteRead=0,nByteWritten=0;
	unsigned char *byteData=NULL;
	FILE *fp;

	fp=fopen(av[1],"r+b");
	if(NULL==fp)
	{
		fprintf(stderr,"Cannot Open Input File!\n");
		return 1;
	}

	unsigned int LBA=0;
	unsigned char buf[2352];
	while(2352==fread(buf,1,2352,fp))
	{
		auto applied=ApplyPatch(2352,buf,sizeof(fileSize1_from),fileSize1_from,sizeof(fileSize1_to),fileSize1_to)+
                     ApplyPatch(2352,buf,sizeof(fileSize2_from),fileSize2_from,sizeof(fileSize2_to),fileSize2_to)+
                     ApplyPatch(2352,buf,sizeof(fileSize3_from),fileSize3_from,sizeof(fileSize3_to),fileSize3_to)+
                     ApplyPatch(2352,buf,sizeof(EXPHeader1_from),EXPHeader1_from,sizeof(EXPHeader1_to),EXPHeader1_to)+
                     ApplyPatch(2352,buf,sizeof(EXPHeader2_from),EXPHeader2_from,sizeof(EXPHeader2_to),EXPHeader2_to)+
                     ApplyPatch(2352,buf,sizeof(EXPHeader3_from),EXPHeader3_from,sizeof(EXPHeader3_to),EXPHeader3_to)+
                     ApplyPatch(2352,buf,sizeof(EXPHeader4_from),EXPHeader4_from,sizeof(EXPHeader4_to),EXPHeader4_to)+
                     ApplyPatch(2352,buf,sizeof(tfr1_from),tfr1_from,sizeof(tfr1_to),tfr1_to)+
                     ApplyPatch(2352,buf,sizeof(tfr2_from),tfr2_from,sizeof(tfr2_to),tfr2_to)+
                     ApplyPatch(2352,buf,sizeof(tfr3_from),tfr3_from,sizeof(tfr3_to),tfr3_to)+
                     ApplyPatchExternal(2352,buf,
                     	sizeof(patch_pattern_lasint),patch_pattern_lasint,sizeof(patch_pattern_lasint)-1,
                     	sizeof(lasint_cdda_code),lasint_cdda_code)+
                     ApplyPatchExternal(2352,buf,
                     	sizeof(patch_pattern_lasint2),patch_pattern_lasint2,sizeof(patch_pattern_lasint2)-1,
                     	sizeof(lasint2_cdda_code),lasint2_cdda_code)+
                     ApplyPatchExternal(2352,buf,
                     	sizeof(patch_pattern_ending),patch_pattern_ending,sizeof(patch_pattern_ending)-1,
                     	sizeof(ending_cdda_code),ending_cdda_code)+
                     0;

		if(0!=applied)
		{
			printf("Applied Patch to LBA=%d\n",LBA);

			auto pos=ftell(fp);
			fseek(fp,pos-2352,SEEK_SET);
			fwrite(buf,1,2352,fp);
			fseek(fp,pos,SEEK_SET); // fwrite apparently only updates the write pointer, or mess up the read pointer.
		}
		++LBA;
	}

	fclose(fp);

	printf("Patched!\n");
	return 0;
}
