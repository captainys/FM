						.386p
						ASSUME	CS:CODE

; For LASINT2.EXP

CODE					SEGMENT
PATCH_APPLIER			PROC

						PUSH	ESI

; Just break CD-ROM Ready Wait
						MOV		BYTE PTR DS:[001AAFE8H],0C3H	; RET
						MOV		BYTE PTR DS:[001AB033H],0C3H	; RET


;Probably after CDDAPlay2 and CDDAPlay4, Command [0010B29B] needs to be cleared.
; 33 DB   XOR EBX,EBX
;000C:001AAE48 8AD8                     MOV	BL,AL
;000C:001AAF0A 8AD8                     MOV	BL,AL
						MOV		WORD PTR DS:[001AAE48H],0DB33H
						MOV		WORD PTR DS:[001AAF0AH],0DB33H


; Replace CDDAPlay
;000C:001AADF0 B906000000               MOV	ECX,00000006
;000C:001AAE5E B906000000               MOV	ECX,00000006
;000C:001AAEB0 B906000000               MOV	ECX,00000006
;000C:001AAF20 B906000000               MOV	ECX,00000006

						MOV		ESI,001AADF0H
						CALL	WRITE_PATCH_CDDAPLAY
						MOV		ESI,001AAE5EH
						CALL	WRITE_PATCH_CDDAPLAY
						MOV		ESI,001AAEB0H
						CALL	WRITE_PATCH_CDDAPLAY
						MOV		ESI,001AAF20H
						CALL	WRITE_PATCH_CDDAPLAY

; Replace CDDAPause
;000C:001AAF62 E8CC000000               CALL	001AB033
; with the following code:
;MOV		BX,0C43AH
;CALL	DWORD PTR CS:[JUMPTABLE+4*6]  ; Address for CMD #6 Save PIC and disable
;MOV		AX,55C0H
;XOR		ECX,ECX
;INT		93H
;CALL	DWORD PTR CS:[JUMPTABLE+4*7]  ; Address for CMD #7 Restore PIC
;RET

;Binary
;66BB3AC4
;2EFF15BC
;8D1A0066
;B8C05533
;C9CD932E
;FF15C08D
;1A00C390

;Little Endian
;0C43ABB66H
;0BC15FF2EH
;066001A8DH
;03355C0B8H
;02E93CDC9H
;08DC015FFH
;090C3001AH

						MOV		ESI,001AAF62H
						MOV		DWORD PTR DS:[ESI   ],0C43ABB66H
						MOV		DWORD PTR DS:[ESI+ 4],0BC15FF2EH
						MOV		DWORD PTR DS:[ESI+ 8],066001A8DH
						MOV		DWORD PTR DS:[ESI+12],03355C0B8H
						MOV		DWORD PTR DS:[ESI+16],02E93CDC9H
						MOV		DWORD PTR DS:[ESI+20],08DC015FFH
						MOV		DWORD PTR DS:[ESI+24],090C3001AH


; Replace CDDAResume
;000C:001AAFA4 E88A000000               CALL	001AB033
; with the following code:
;MOV		BX,0C43AH
;CALL	DWORD PTR CS:[JUMPTABLE+4*6]  ; Address for CMD #6 Save PIC and disable
;MOV		AX,56C0H
;XOR		ECX,ECX
;INT		93H
;CALL	DWORD PTR CS:[JUMPTABLE+4*7]  ; Address for CMD #7 Restore PIC
;RET

;Binary
;66BB3AC4
;2EFF15BC
;8D1A0066
;B8C05633
;C9CD932E
;FF15C08D
;1A00C390

;Little Endian
;0C43ABB66H
;0BC15FF2EH
;066001A8DH
;03356C0B8H
;02E93CDC9H
;08DC015FFH
;090C3001AH

						MOV		ESI,001AAFA4H
						MOV		DWORD PTR DS:[ESI   ],0C43ABB66H
						MOV		DWORD PTR DS:[ESI+ 4],0BC15FF2EH
						MOV		DWORD PTR DS:[ESI+ 8],066001A8DH
						MOV		DWORD PTR DS:[ESI+12],03356C0B8H
						MOV		DWORD PTR DS:[ESI+16],02E93CDC9H
						MOV		DWORD PTR DS:[ESI+20],08DC015FFH
						MOV		DWORD PTR DS:[ESI+24],090C3001AH


;000C:001AA157 750A                     JNE	001AA163                         <- ‚±‚ê‚Íâ‘Î JNE 001AA384‚Å‚ ‚é‚×‚«‚¾B  750A -> 752B
; This must be JNE 1A7394, otherwise CDDAPlay8 will be called 60 times while the remaining seconds is 16.???
						MOV		BYTE PTR DS:[001AA158H],2BH


; Just in case, prevent CDDAStop called without enabling interrupt.
; Let it fall to CDDAPause
;000C:001AAF5F CD93                     INT	93
;000C:001AAF61 C3                       RET
						MOV		ESI,001AAF5FH
						MOV		WORD PTR DS:[ESI  ],9090H ; NOPNOP
						MOV		BYTE PTR DS:[ESI+2],90H   ; NOP

						POP		ESI


						RET

WRITE_PATCH_CDDAPLAY:
;Assembly
;MOV		BX,0C43AH
;CALL	DWORD PTR CS:[JUMPTABLE+4*6]  ; Address for CMD #6 Save PIC and disable
;MOV		AX,52C0H
;XOR		ECX,ECX
;INT		93H
;MOV		AX,72C0H
;MOV		BX,[ESI]
;MOV		CX,[ESI+2]
;MOV		DX,[ESI+4]
;INT		93H
;CALL	DWORD PTR CS:[JUMPTABLE+4*7]  ; Address for CMD #7 Restore PIC
;RET

;Binary
;66BB3AC4
;2EFF15BC
;8D1A0066
;B8C05233
;C9CD9366
;B8C07266
;8B1E668B
;4E02668B
;5604CD93
;2EFF15C0
;8D1A00C3

;Little Endian
;0C43ABB66H
;0BC15FF2EH
;066001A8DH
;03352C0B8H
;06693CDC9H
;06672C0B8H
;08B661E8BH
;08B66024EH
;093CD0456H
;0C015FF2EH
;0C3001A8DH

						; 077CDFB90H  ; STI, NOP, INT 77H
						MOV		DWORD PTR DS:[ESI   ],0C43ABB66H
						MOV		DWORD PTR DS:[ESI+ 4],0BC15FF2EH
						MOV		DWORD PTR DS:[ESI+ 8],066001A8DH
						MOV		DWORD PTR DS:[ESI+12],03352C0B8H
						MOV		DWORD PTR DS:[ESI+16],06693CDC9H
						MOV		DWORD PTR DS:[ESI+20],06672C0B8H
						MOV		DWORD PTR DS:[ESI+24],08B661E8BH
						MOV		DWORD PTR DS:[ESI+28],08B66024EH
						MOV		DWORD PTR DS:[ESI+32],093CD0456H
						MOV		DWORD PTR DS:[ESI+36],0C015FF2EH
						MOV		DWORD PTR DS:[ESI+40],0C3001A8DH
						RET


PATCH_APPLIER			ENDP


CODE					ENDS
						END

