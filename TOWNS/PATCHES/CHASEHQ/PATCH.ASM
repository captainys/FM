						.386p
						ASSUME	CS:CODE

CODE					SEGMENT


PATCH_APPLIER			PROC

						PUSH	ESI



; Just break CD-ROM Ready Wait
						MOV		BYTE PTR DS:[001A8283H],0C3H	; RET
						MOV		BYTE PTR DS:[001A8238H],0C3H	; RET




;Probably after CDDAPlay2 and CDDAPlay4, Command [0010B29B] needs to be cleared.
; 33 DB   XOR EBX,EBX
;000C:001A8098 8AD8                     MOV	BL,AL
;000C:001A815A 8AD8                     MOV	BL,AL

						MOV		WORD PTR DS:[001A8098H],0DB33H
						MOV		WORD PTR DS:[001A815AH],0DB33H



; Replace CDDAPlay
;000C:001A8040 B906000000               MOV	ECX,00000006
;000C:001A80AE B906000000               MOV	ECX,00000006
;000C:001A8100 B906000000               MOV	ECX,00000006
;000C:001A8170 B906000000               MOV	ECX,00000006
						MOV		ESI,001A8040H
						CALL	WRITE_PATCH_CDDAPLAY
						MOV		ESI,001A80AEH
						CALL	WRITE_PATCH_CDDAPLAY
						MOV		ESI,001A8100H
						CALL	WRITE_PATCH_CDDAPLAY
						MOV		ESI,001A8170H
						CALL	WRITE_PATCH_CDDAPLAY

; Replace CDDAPause with the following code
;MOV		BX,0C43AH
;CALL	DWORD PTR CS:[JUMPTABLE+4*6]  ; Address for CMD #6 Save PIC and disable
;MOV		AX,55C0H
;XOR		ECX,ECX
;INT		93H
;CALL	DWORD PTR CS:[JUMPTABLE+4*7]  ; Address for CMD #7 Restore PIC
;RET

; Binary
;66BB3AC4
;2EFF15CC
;5F1A0066
;B8C05533
;C9CD932E
;FF15D05F
;1A00C390

; Little Endian
;C43ABB66
;CC15FF2E
;66001A5F
;3355C0B8
;2E93CDC9
;5FD015FF
;90C3001A

						MOV		ESI,001A81B2H
						MOV		DWORD PTR DS:[ESI   ],0C43ABB66H
						MOV		DWORD PTR DS:[ESI+ 4],0CC15FF2EH
						MOV		DWORD PTR DS:[ESI+ 8],066001A5FH
						MOV		DWORD PTR DS:[ESI+12],03355C0B8H
						MOV		DWORD PTR DS:[ESI+16],02E93CDC9H
						MOV		DWORD PTR DS:[ESI+20],05FD015FFH
						MOV		DWORD PTR DS:[ESI+24],090C3001AH


; Replace CDDAResume with the following code
;MOV		BX,0C43AH
;CALL	DWORD PTR CS:[JUMPTABLE+4*6]  ; Address for CMD #6 Save PIC and disable
;MOV		AX,56C0H
;XOR		ECX,ECX
;INT		93H
;CALL	DWORD PTR CS:[JUMPTABLE+4*7]  ; Address for CMD #7 Restore PIC
;RET

;Binary
;66BB3AC4
;2EFF15CC
;5F1A0066
;B8C05633
;C9CD932E
;FF15D05F
;1A00C390

;Little Endian
;C43ABB66
;CC15FF2E
;66001A5F
;3356C0B8
;2E93CDC9
;5FD015FF
;90C3001A

						MOV		ESI,001A81F4H
						MOV		DWORD PTR DS:[ESI   ],0C43ABB66H
						MOV		DWORD PTR DS:[ESI+ 4],0CC15FF2EH
						MOV		DWORD PTR DS:[ESI+ 8],066001A5FH
						MOV		DWORD PTR DS:[ESI+12],03356C0B8H
						MOV		DWORD PTR DS:[ESI+16],02E93CDC9H
						MOV		DWORD PTR DS:[ESI+20],05FD015FFH
						MOV		DWORD PTR DS:[ESI+24],090C3001AH


;000C:001A7367 750A                     JNE	001A7373                         <- ‚±‚ê‚Íâ‘Î JNE 001A7394‚Å‚ ‚é‚×‚«‚¾B  750A -> 752B
; This must be JNE 1A7394, otherwise CDDAPlay8 will be called 60 times while the remaining seconds is 16.???
						MOV		BYTE PTR DS:[001A7368H],2BH


; Just in case, prevent CDDAStop called without enabling interrupt.
; Let it fall to CDDAPause
;000C:001A81AF CD93                     INT	93
;000C:001A81B1 C3                       RET
						MOV		ESI,001A81AFH
						MOV		WORD PTR DS:[ESI  ],9090H ; NOPNOP
						MOV		BYTE PTR DS:[ESI+2],90H   ; NOP



; INT 77H Trap
; See which function is calling.
;  50                           PUSH	EAX 
;  53                           PUSh	EBX 
;  66 8B 44 24 0A               MOV		AX,WORD PTR [ESP+8+2] 
;  66 8B 5C 24 08               MOV		BX,WORD PTR	[ESP+8] 
;  CD 77                        INT		77H 
;  5B                           POP		EBX 
;  58                           POP		EAX 
;  C3                           RET 
;  90 90 90NOP NOP NOP

;Binary
;5053668B
;44240A66
;8B5C2408
;CD775B58
;C3909090

;Little Endian
;08B665350H
;0660A2444H
;008245C8BH
;0585B77CDH
;0909090C3H

;						MOV		ESI,001A7FE0H
;						MOV		DWORD PTR DS:[ESI   ],08B665350H
;						MOV		DWORD PTR DS:[ESI+ 4],0660A2444H
;						MOV		DWORD PTR DS:[ESI+ 8],008245C8BH
;						MOV		DWORD PTR DS:[ESI+12],0585B77CDH
;						MOV		DWORD PTR DS:[ESI+16],0909090C3H


						POP		ESI


						RET

WRITE_PATCH_CDDAPLAY:
; Replace CDDAPlay with the following code
;MOV		BX,0C43AH
;CALL	DWORD PTR CS:[JUMPTABLE+4*6]  ; Address for CMD #6 Save PIC and disable
;MOV		AX,52C0H
;INT		93H
;MOV		AX,72C0H
;MOV		BX,[ESI]
;MOV		CX,[ESI+2]
;MOV		DX,[ESI+4]
;INT		93H
;CALL	DWORD PTR CS:[JUMPTABLE+4*7]  ; Address for CMD #7 Restore PIC
;RET

;Binary
;66BB3AC4
;2EFF15CC
;5F1A0066
;B8C05233
;C9CD9366
;B8C07266
;8B1E668B
;4E02668B
;5604CD93
;2EFF15D0
;5F1A00C3

;Little Endian
;C43ABB66H
;CC15FF2EH
;66001A5FH
;3352C0B8H
;6693CDC9H
;6672C0B8H
;8B661E8BH
;8B66024EH
;93CD0456H
;D015FF2EH
;C3001A5FH

						; 077CDFB90H  ; STI, NOP, INT 77H
						MOV		DWORD PTR DS:[ESI   ],0C43ABB66H
						MOV		DWORD PTR DS:[ESI+ 4],0CC15FF2EH
						MOV		DWORD PTR DS:[ESI+ 8],066001A5FH
						MOV		DWORD PTR DS:[ESI+12],03352C0B8H
						MOV		DWORD PTR DS:[ESI+16],06693CDC9H
						MOV		DWORD PTR DS:[ESI+20],06672C0B8H
						MOV		DWORD PTR DS:[ESI+24],08B661E8BH
						MOV		DWORD PTR DS:[ESI+28],08B66024EH
						MOV		DWORD PTR DS:[ESI+32],093CD0456H
						MOV		DWORD PTR DS:[ESI+36],0D015FF2EH
						MOV		DWORD PTR DS:[ESI+40],0C3001A5FH


						RET


PATCH_APPLIER			ENDP


CODE					ENDS
						END

